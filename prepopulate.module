<?php
/* prepopulate.module -- fill forms with data from GET
 * ea. Farris <eafarris@gmail.com>
 *    based on an idea from chx, from the conversation at
 *    http://www.drupal.org/node/27155

 * used to be rest.module, from my sandbox
*/

// $Id$

function prepopulate_help($section) {
  switch($section) {
    case 'admin/modules#description':
      return t('Pre-populates forms for allowed content types with HTTP GET data');
      break;
  } // endswitch $section
} // endfunction prepopulate_help()

function prepopulate_form_alter($form_id, &$form) {
  $type = $form['type']['#value'];
  $node = $form['#node'];

  switch ($form_id) {
    case $type . '_node_settings': // on a node settings form, praise be to the FormsAPI!
      $form['workflow']['prepopulate_allowed_' . $type] = array(
        '#type' => 'checkbox',
        '#title' => 'Prepopulate form from URL?',
        '#default_value' => variable_get('prepopulate_allowed_' . $type, TRUE),
        '#description' => t('Allows fields to be prepopulated from the URL'),
      );
    break;
  } // endswitch $form_id

  if (variable_get('prepopulate_allowed_' . $type, TRUE) && $_GET['edit']) {
    foreach (array_keys( (array) $_GET['edit']) as $getvar) {
      _prepopulate_get_walk($form, $getvar);
    } // endforeach get variable
  } // endif any get vars
} // endfunction prepopulate_form_alter()

function _prepopulate_get_walk(&$form, $getslice) {
  foreach (array_keys( (array) $getslice) as $getvar) {
    if (is_array($getslice)) {
      _prepopulate_get_walk($form, $getslice);
    }
    else {
      _prepopulate_form_walk($form, $getslice);
    }
  } // endforeach walking through get
} // endfunction _prepopulate_get_walk

function _prepopulate_form_walk(&$form, $getvar) {
  foreach (element_children($form) as $formkey) {
    if ($formkey == $getvar) {
      $form[$formkey]['#default_value'] = $_GET['edit'][$getvar];
    }
    else {
      _prepopulate_form_walk($form[$formkey], $getvar);
    }
  } // endforeach walking through form
} // endfunction _prepopulate_form_walk

// vim: tw=300 nowrap syn=php
